---
params:
  titleName: "Metabolite Template File"
  metabData: ""
  metabStats: ""
  pmart_inputs: ""
title: "`r params$titleName`"
date: "`r format(Sys.time(), '%B %d, %Y')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, error = FALSE)
library(dplyr); library(pmartR); library(knitr); library(DT); library(ggplot2);
library(data.table); library(patchwork); library(purrr)

# This data will be passed to the markdown through shiny
metabData <- params$metabData
metabDataAttr <- attributes(metabData)
metabStats <- params$metabStats
metabStatsAttr <- attributes(metabStats)
pmart_inputs <- params$pmart_inputs
```

## Upload Data 

### *Expression Data*

A molecule expression data file called **`r pmart_inputs$file_edata$name`** was uploaded to pmart. 
The column that designates unique molecules was marked as **`r metabDataAttr$cnames$edata_cname`.**
`r if (metabDataAttr$data_info$data_scale_orig == metabDataAttr$data_info$data_scale) {"The original scale of the data was **metabDataAttr$data_info$data_scale_orig** and remained unchanged."} else {paste0("The original scale of the data was **", metabDataAttr$data_info$data_scale_orig, "** and was changed to **", metabDataAttr$data_info$data_scale, "**.")}` 
The value to denote missing data was **`r pmart_inputs$na_symbol`** and the expression data
**`r ifelse(pmart_inputs$normalized_yn == "0", "was not already", "was already")`** normalized. 

`r if (is.null(metabDataAttr$cnames$emeta_cname) == FALSE) {paste0("### *Biomolecule Information*\nAn associated biomolecule information file was also uploaded called **", pmart_inputs$file_emeta$name, "** and the protein identifier column was designated as **", metabDataAttr$cnames$emeta_cname, "**.")}`

`r if ("Var1" %in% colnames(metabData$f_data) == FALSE) {paste0("### *Sample Information*\nAn associated sample information file was also uploaded called **", pmart_inputs$file_fdata$name, "**. Trimmed samples names **", ifelse(pmart_inputs$usevizsampnames == "No", "were not", "were"), "** used. The column in the sample information file which indicates sample names was designated as **", metabDataAttr$cnames$fdata_cname, "**.")}`

`r if (is.null(metabDataAttr$group_DF) == FALSE) {paste0("## Group Samples\n### *Grouping Information*\nThis table summarizes to which group or covariate each column in the Expression Data belongs.")}`

```{r Grouping Information: Main Effects and Covariates}
if (is.null(metabDataAttr$group_DF) == FALSE) {
  metabDataAttr$group_DF %>% kable()
}
```

## Data Summary

### *Summary Table*

The first column in the table below denotes a property of the peptide data, and the "Data" column
states that property's value.

```{r Data Summary: Main Table}
metabDataSum <- data.frame("Data" = summary(metabData))
metabDataSum %>% kable()
```

### *Missing Value Table*

In the table below, the first column denotes the sample and the second is the missing number of observations.
The third column represents the second as a proportion of the total number of observations
for that sample. 

```{r Data Summary: Missing Value Table}
metabData$e_data %>%
  select(-pmart_inputs$id_col) %>%
  map(~sum(is.na(.))) %>%
  data.frame() %>%
  t() %>%
  data.frame() %>%
  setNames("Missing Observations") %>%
  mutate(
    "Proportion Missing" = round(`Missing Observations` / nrow(metabData$e_data), 3),
  ) %>% kable()
```

`r if(length(metabDataAttr$filters) > 0) {paste0("## Filters\nA total of **", length(metabDataAttr$filters), "** filter(s) were applied. See the table below for descriptions of the filters and their order.\n### *Summary of Applied Filters*")}`

```{r Filter: Table Summarizing Applied Filters}
#  Put applied filters in a table
FilterTable <- NULL

if (length(metabDataAttr$filters) != 0) {
  
  # Iterate through all the filters for the table, apply different logic for each filter type
  FilterTable <- do.call(rbind, lapply(metabDataAttr$filters, function(filter) {
    
    # Molecule Filter
    if (filter$type == "moleculeFilt") {
      return(c("Filter" = "Molecule Filter", "Type" = "Biomolecule", "Parameters" = 
               paste0("Min Number Molecules: ", filter$threshold), 
               "Summary" = paste0(filter$filtered %>% length(), " biomolecule(s) were filtered.")))
    } else
    
    # Proteomics Filter
    if (filter$type == "proteomicsFilt") {
      return(c("Filter" = "Proteomics Filter", "Type" = "Biomolecule", "Parameters" = 
               paste0("Min Number of Peptides: ", filter$threshold$min_num_peps,
                      " & Degenerate Peptides Removed: ", ifelse(filter$threshold$degen_peps, "Yes", "No")),
               "Summary" = paste0(filter$filtered$e_data_remove %>% length(), " biomolecule(s) were filtered and ",
                                  filter$filtered$e_meta_remove %>% length(), " protein(s) were filtered.")))
    } else
      
    # CV Filter
    if (filter$type == "cvFilt") {
      return(c("Filter" = "CV Filter", "Type" = "Biomolecule", "Parameters" = 
               paste0("Max CV: ", filter$threshold),
               "Summary" = paste0(filter$filtered %>% length(), " biomolecule(s) were filtered.")))
    } else
      
    # imd-ANOVA filter
    if (filter$type == "imdanovaFilt") {
      return(c("Filter" = "imd-ANOVA Filter", "Type" = "Biomolecule", "Parameters" = 
               paste0("Min ANOVA: ", filter$threshold$min_nonmiss_anova,
                      " & Min G-Test: ", filter$threshold$min_nonmiss_gtest),
               "Summary" = paste0(filter$filtered %>% length(), " biomolecule(s) were filtered.")))
    } else 
      
    # rmd Filter
    if (filter$type == "rmdFilt") {
      return(c("Filter" = "rMD Filter", "Type" = "Sample", "Parameters" = 
                 paste0("P-Value Threshold: ", filter$threshold, " & Metrics Used: ",
                        pmart_inputs$rmd_metrics %>% paste(collapse = ", ")),
               "Summary" = paste0(filter$filtered %>% length(), " sample(s) were filtered.")))
    } else 
      
    # Custom filter
    if (filter$type == "customFilt") {
      return(c("Filter" = "Custom Filter", "Type" = "Sample or Biomolecule", "Parameters" = "",
               "Summary" = paste0(filter$filtered$f_data_remove %>% length(), " sample(s) were filtered. ",
                           filter$filtered$e_data_remove %>% length(), " biomolecule(s) were filtered. ", 
                           filter$filtered$e_meta_remove %>% length(), " protein(s) were filtered.")))
      
    } else {stop(paste0(filter$type, " is not a recognized filter type."))}
  
  })) %>% data.table()
  
  cbind("Order" = 1:nrow(FilterTable), FilterTable) %>% kable()
  
}
```

```{r Create Filter Text}
# imd-ANOVA Filter
imdAnovFilterText <- "imd-ANOVA filters were not applied to the data."

if ("imd-ANOVA Filter" %in% FilterTable$Filter) {
  imdAnovFilterText <- paste0("An ANOVA filter can be applied to the data which removes biomolecule(s) (",
    paste0(metabDataAttr$cnames$edata_cname, "s"), ") not having at least a minimum number ",
    "of non-missing values per group (Min ANOVA). Additionaly, an IMD (independence of missing data) filter can",
    " be applied to the data, removing biomolecules not having at least a minimum number of non-missing ",
    "values (Min G-Test) in at least one of the groups.")
}

# rMD Filter
rMDFilterText <- "rMD filters were not applied to the data."

if ("rMD Filter" %in% FilterTable$Filter) {
  rMDFilterText <- paste0("A robust Mahalanobis distance (rMD) filter was applied to the",
    " data, removing sample(s) (", paste0(metabDataAttr$cnames$fdata_cname, "s"), ") with an associated ",
    "rMD-associated p-value less than the threshold (P-Value Threshold). Metrics ",
    "used to calculate the p-value are also included (Metrics Used).")
}

# Custom filter
customFilterText <- "Custom filters were not applied to the data."

if ("Custom Filter" %in% FilterTable$Filter) {
  customFilterText <- "Custom filters can be used to remove samples, biomolecules, or proteins."
}
```

`r if ("Molecule Filter" %in% FilterTable$Filter) {paste0("### *Molecule Filter*\nA molecule filter was applied to the data, which removes biomolecule(s), **", metabDataAttr$cnames$edata_cname, "(s)**, not having at least the minimum number of samples (Min Number Molecules).")}`

`r if ("CV Filter" %in% FilterTable$Filter) {paste0("### *CV Filter*\nA coefficient of variation (CV) filter was applied to the data which removes biomolecule(s), **", metabDataAttr$cnames$edata_cname, "(s)**, with a CV greater than the threshold (Max CV).")} `

`r if ("imd-ANOVA Filter" %in% FilterTable$Filter) {paste0("### *imd-ANOVA Filter*\nAn ANOVA filter can be applied to the data which removes biomolecule(s), **", metabDataAttr$cnames$edata_cname, "(s)** of non-missing values per group (Min ANOVA). Additionaly, an IMD (independence of missing data) filter can be applied to the data, removing biomolecules not having at least a minimum number of non-missing values (Min G-Test) in at least one of the groups.")}`


### *imd-ANOVA Filter*

`r imdAnovFilterText`

### *rMD Filter*

`r rMDFilterText`

### *Custom Filter*

`r customFilterText`

## Normalization

Metabolite data **`r ifelse(metabDataAttr$data_info$norm_info$is_normalized, "was", "was not")`**
normalized.

### *Manual*

```{r Normalization: Manual}
if (is.null(metabDataAttr$data_info$norm_info$norm_type) == FALSE 
    && metabDataAttr$data_info$norm_info$norm_type == "global") {
  
  SubsetParameters <- ifelse(is.null(metabDataAttr$data_info$norm_info$subset_params), "",
    paste(lapply(names(metabDataAttr$data_info$norm_info$subset_params), function(name) {
      paste0(name, ": ", metabDataAttr$data_info$norm_info$subset_params[[name]])}), collapse = " & "))
  
  data.table("Attribute" = c("Subset Function", "Subset Parameters", "Normalization Function"),
             "Value" = c(metabDataAttr$data_info$norm_info$subset_fn, 
                         SubsetParameters, 
                         metabDataAttr$data_info$norm_info$norm_fn)) %>% kable()
}

plot(metabData, bw_theme = TRUE)
```

## Statistical Analysis

The statistical analysis step **`r ifelse(is.null(metabStats), "was not", "was")`** run.

```{r Analysis: Comparison Text}
ComparisonsText <- ""

if (is.null(metabStats) == FALSE) {
  ComparisonsText <- paste("The following groups were compared:", paste0(paste(metabStatsAttr$comparisons, sep = ","), 
    "."), "Reported below are the parameters used in the statistical analysis,",
    "followed by the number of siginificant biomolecules for each comparison.")
}
```

`r ComparisonsText`

```{r Analysis: Input Parameters}
if (is.null(metabStats) == FALSE) {
  data.table("Attribute" = c("Test Method", "Multiple Comparison Adjustment", 
      "Significance Threshold"), "Value" = c(metabStatsAttr$statistical_test, metabStatsAttr$adjustment_method,
      metabStatsAttr$pval_thresh)) %>% kable()
}

if (is.null(metabStats) == FALSE) {
  metabStatsAttr$number_significant[1:4] %>% kable("latex") 
}

if (is.null(metabStats) == FALSE) {
  plot(metabStats, bw_theme = TRUE)
}
```

`r if (TRUE) {"## Kelly didn't lie"}`


