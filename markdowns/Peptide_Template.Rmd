---
params:
  titleName: "Peptide Template File"
  pepData: ""
  pepStats: ""
  pmart_inputs: ""
  spans_results: ""
title: "`r params$titleName`"
date: "`r format(Sys.time(), '%B %d, %Y')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, error = FALSE)
library(dplyr); library(pmartR); library(knitr); library(DT); library(ggplot2);
library(data.table); library(patchwork); library(purrr); library(glue); library(crayon)

# This data will be passed to the markdown through shiny
pepData <- params$pepData
pepDataAttr <- attributes(pepData)
pepStats <- params$pepStats
pepStatsAttr <- attributes(pepStats)
pmart_inputs <- params$pmart_inputs
spans_results <- params$spans_results
```

## Upload Data 

### *Expression Data*

A **`r ifelse(pmart_inputs$labeled_yn, "labelled", "unlabelled")`** peptide expression 
data file called **`r pmart_inputs$file_edata$name`** was uploaded to pmart. 
The column that designates unique peptides was marked as **`r pepDataAttr$cnames$edata_cname`.**
`r if (pepDataAttr$data_info$data_scale_orig == pepDataAttr$data_info$data_scale) {"The original scale of the data was **pepDataAttr$data_info$data_scale_orig** and remained unchanged."} else {paste0("The original scale of the data was **", pepDataAttr$data_info$data_scale_orig, "** and was changed to **", pepDataAttr$data_info$data_scale, "**.")}` 
The value to denote missing data was **`r pmart_inputs$na_symbol`** and the expression data
**`r ifelse(pmart_inputs$normalized_yn == "0", "was not already", "was already")`** normalized. 

`r if (is.null(pepDataAttr$cnames$emeta_cname) == FALSE) {paste0("### *Biomolecule Information*\nAn associated biomolecule information file was also uploaded called **", pmart_inputs$file_emeta$name, "** and the protein identifier column was designated as **", pepDataAttr$cnames$emeta_cname, "**.")}`

`r if ("Var1" %in% colnames(pepData$f_data) == FALSE) {paste0("### *Sample Information*\nAn associated sample information file was also uploaded called **", pmart_inputs$file_fdata$name, "**. Trimmed samples names **", ifelse(pmart_inputs$usevizsampnames == "No", "were not", "were"), "** used. The column in the sample information file which indicates sample names was designated as **", pepDataAttr$cnames$fdata_cname, "**.")}`

`r if (is.null(pepDataAttr$group_DF) == FALSE) {paste0("## Group Samples\n### *Grouping Information*\nThis table summarizes to which group or covariate each column in the Expression Data belongs.")}`

```{r Grouping Information: Main Effects and Covariates}
if (is.null(pepDataAttr$group_DF) == FALSE) {
  pepDataAttr$group_DF %>% kable()
}
```

## Data Summary

### *Summary Table*

The first column in the table below denotes a property of the peptide data, and the "Data" column
states that property's value.

```{r Data Summary: Main Table}
pepDataSum <- data.frame("Data" = summary(pepData))
pepDataSum %>% kable()
```

### *Missing Value Table*

In the table below, the first column denotes the sample and the second is the missing number of observations.
The third column represents the second as a proportion of the total number of observations
for that sample. 

```{r Data Summary: Missing Value Table}
pepData$e_data %>%
  select(-pmart_inputs$id_col) %>%
  purrr::map(~sum(is.na(.))) %>%
  data.frame() %>%
  t() %>%
  data.frame() %>%
  setNames("Missing Observations") %>%
  mutate(
    "Proportion Missing" = round(`Missing Observations` / nrow(pepData$e_data), 3),
  ) %>% kable()
```

`r if(length(pepDataAttr$filters) > 0) {paste0("## Filters\nA total of **", length(pepDataAttr$filters), "** filter(s) were applied. See the table below for descriptions of the filters and their order.\n\n### *Summary of Applied Filters*")}`

```{r Filter: Table Summarizing Applied Filters}
#  Put applied filters in a table
FilterTable <- NULL

if (length(pepDataAttr$filters) != 0) {
  
  # Iterate through all the filters for the table, apply different logic for each filter type
  FilterTable <- do.call(rbind, lapply(pepDataAttr$filters, function(filter) {
    
    # Molecule Filter
    if (filter$type == "moleculeFilt") {
      return(c("Filter" = "Molecule Filter", "Type" = "Biomolecule", "Parameters" = 
               paste0("Min Number Molecules: ", filter$threshold), 
               "Summary" = paste0(filter$filtered %>% length(), " biomolecule(s) were filtered.")))
    } else
    
    # Proteomics Filter
    if (filter$type == "proteomicsFilt") {
      return(c("Filter" = "Proteomics Filter", "Type" = "Biomolecule", "Parameters" = 
               paste0("Min Number of Peptides: ", filter$threshold$min_num_peps,
                      " & Degenerate Peptides Removed: ", ifelse(filter$threshold$degen_peps, "Yes", "No")),
               "Summary" = paste0(filter$filtered$e_data_remove %>% length(), " biomolecule(s) were filtered and ",
                                  filter$filtered$e_meta_remove %>% length(), " protein(s) were filtered.")))
    } else
      
    # CV Filter
    if (filter$type == "cvFilt") {
      return(c("Filter" = "CV Filter", "Type" = "Biomolecule", "Parameters" = 
               paste0("Max CV: ", filter$threshold),
               "Summary" = paste0(filter$filtered %>% length(), " biomolecule(s) were filtered.")))
    } else
      
    # imd-ANOVA filter
    if (filter$type == "imdanovaFilt") {
      return(c("Filter" = "imd-ANOVA Filter", "Type" = "Biomolecule", "Parameters" = 
               paste0("Min ANOVA: ", filter$threshold$min_nonmiss_anova,
                      " & Min G-Test: ", filter$threshold$min_nonmiss_gtest),
               "Summary" = paste0(filter$filtered %>% length(), " biomolecule(s) were filtered.")))
    } else 
      
    # rmd Filter
    if (filter$type == "rmdFilt") {
      return(c("Filter" = "rMD Filter", "Type" = "Sample", "Parameters" = 
                 paste0("P-Value Threshold: ", filter$threshold, " & Metrics Used: ",
                        pmart_inputs$rmd_metrics %>% paste(collapse = ", ")),
               "Summary" = paste0(filter$filtered %>% length(), " sample(s) were filtered.")))
    } else 
      
    # Custom filter
    if (filter$type == "customFilt") {
      return(c("Filter" = "Custom Filter", "Type" = "Sample or Biomolecule", "Parameters" = "",
               "Summary" = paste0(filter$filtered$f_data_remove %>% length(), " sample(s) were filtered. ",
                           filter$filtered$e_data_remove %>% length(), " biomolecule(s) were filtered. ", 
                           filter$filtered$e_meta_remove %>% length(), " protein(s) were filtered.")))
      
    } else {stop(paste0(filter$type, " is not a recognized filter type."))}
  
  })) %>% data.table()
  
  cbind("Order" = 1:nrow(FilterTable), FilterTable) %>% kable()
  
}
```

`r if ("Molecule Filter" %in% FilterTable$Filter) {paste0("### *Molecule Filter*\nA molecule filter was applied to the data, which removes biomolecule(s), **", pepDataAttr$cnames$edata_cname, "(s)**, not having at least the minimum number of samples (Min Number Molecules).")}`

`r if ("Proteomics Filter" %in% FilterTable$Filer) {paste0("### *Proteomics Filter*\nA degenerate peptide filter (Degenerate Peptides Removed) was applied to the data, which identifies peptides, **", pepDataAttr$cnames$edata_cname, "(s)**, not belonging to a single protein. Additionally, a protein filter can be applied to the data which identifies proteins not having at least a minimum number of peptides (Min Number of Peptides) mapping to them.")}`

`r if ("CV Filter" %in% FilterTable$Filter) {paste0("### *CV Filter*\nA coefficient of variation (CV) filter was applied to the data which removes biomolecule(s), **", pepDataAttr$cnames$edata_cname, "(s)**, with a CV greater than the threshold (Max CV).")} `

`r if ("imd-ANOVA Filter" %in% FilterTable$Filter) {paste0("### *imd-ANOVA Filter*\nAn ANOVA filter can be applied to the data which removes biomolecule(s), **", pepDataAttr$cnames$edata_cname, "(s)**, of non-missing values per group (Min ANOVA). Additionaly, an IMD (independence of missing data) filter can be applied to the data, removing biomolecules not having at least a minimum number of non-missing values (Min G-Test) in at least one of the groups.")}`

`r if ("rMD Filter" %in% FilterTable$Filter) {paste0("### *rMD Filter*\nA robust Mahalanobis distance (rMD) filter was applied to the data, removing sample(s), **", pepDataAttr$cnames$fdata_cname, "(s)**, with an associated rMD p-value of less than the threshold (P-Value Threshold). Metrics used to calculate the p-values are also included (Metrics Used).")}`

`r if ("Custom Filter" %in% FilterTable$Filter) {paste0("### *Custom Filter*\n Custom filters can be used to remove samples, biomolecules or proteins.")}`

`r if (pepDataAttr$data_info$norm_info$is_normalized) {"## Normalization\nPeptide data **was** normalized.\n\n### *Manual*"}`

```{r Normalization: Manual, Plot}
if (pepDataAttr$data_info$norm_info$is_normalized) {
  plot(pepData, bw_theme = TRUE)  
}
```

```{r Normalization: Manual, Data Table}
if (is.null(pepDataAttr$data_info$norm_info$norm_type) == FALSE 
    && pepDataAttr$data_info$norm_info$norm_type == "global") {
  
  SubsetParameters <- ifelse(is.null(pepDataAttr$data_info$norm_info$subset_params), "",
    paste(lapply(names(pepDataAttr$data_info$norm_info$subset_params), function(name) {
      paste0(name, ": ", pepDataAttr$data_info$norm_info$subset_params[[name]])}), collapse = " & "))
  
  data.table("Attribute" = c("Subset Function", "Subset Parameters", "Normalization Function"),
             "Value" = c(pepDataAttr$data_info$norm_info$subset_fn, 
                         SubsetParameters, 
                         pepDataAttr$data_info$norm_info$norm_fn)) %>% kable()
}
```

`r if (is.null(spans_results) == FALSE) {"### *SPANS*\n\nSPANS was run to determine optimum normalization parameters."}`

```{r, SPANS}
if (is.null(spans_results) == FALSE) {
  plot(spans_results)
}
``` 

`r if (is.null(pepStats) == FALSE) {"## Statistical Analysis\n The statistical analysis step was run."}`

```{r Analysis: Comparison Text}
ComparisonsText <- ""

if (is.null(pepStats) == FALSE) {
  ComparisonsText <- paste("The following groups were compared:", paste0(paste(pepStatsAttr$comparisons, sep = ","), 
    "."), "Reported below are the parameters used in the statistical analysis,",
    "followed by the number of siginificant biomolecules for each comparison.")
}
```

`r ComparisonsText`

```{r Analysis: Input Parameters}
if (is.null(pepStats) == FALSE) {
  data.table("Attribute" = c("Test Method", "Multiple Comparison Adjustment", 
      "Significance Threshold"), "Value" = c(pepStatsAttr$statistical_test, pepStatsAttr$adjustment_method,
      pepStatsAttr$pval_thresh)) %>% kable()
}

if (is.null(pepStats) == FALSE) {
  pepStatsAttr$number_significant[1:4] %>% kable("latex") 
}

if (is.null(pepStats) == FALSE) {
  plot(pepStats, bw_theme = TRUE)
}
```

`r if (pmart_inputs$ReportCode) {paste0('## Example Code\n### *Upload Data *\nlibrary(pmartR)\n\nlibrary(pmartRdata)\n\ndata("pep_edata")\n\ndata("pep_fdata")\n\ndata("pep_emeta")\n\nmypepData <- as.pepData(e_data = pep_edata, f_data = pep_fdata, e_meta = pep_emeta, edata_cname = "Mass_Tag_ID", fdata_cname = "SampleID", edata_cname = "Protein")\n\nsummary(mypepData)\n\n', ifelse(is.null(pepDataAttr$group_DF), '\n', '### *Group Samples*\nmypepData <- group_designation(omicsData = mypepData, main_effects = "Condition")\n\nplot(mypepData)\n\n'), ifelse(length(pepDataAttr$filters) == 0, '', '### *Apply Filters*\nNote: Apply filters only if they make sense given the context of the analysis, and their plots. You can apply any filter with: applyFilt(filter, mypepData, other_parameters), and visualize any filter with plot(filter, other_parameters).\n\nmoleculeFilt <- molecule_filter(omicsData = mypepData); plot(moleculeFilt, min_num = 2)\n\ncvFilt <- cv_filter(mypepData); plot(cvFilt, cv_threshold = 80)\n\nimdFilt <- imdanova_filter(omicsData = mypepData); plot(imdFilt, min_nonmiss_anova = 2)\n\nrmdFilt <- rmd_filter(omicsData = mypepData, metrics = c("MAD", "Skewness", "Correlation")); plot(rmdFilt, pvalue_threshold = 0.0001)\n\ncustFilt <- custom_filter(omicsData = mypepData, f_data_remove = "Infection1")\n\n'), ifelse(pepDataAttr$data_info$norm_info$is_normalized == FALSE, '', '### *Normalization*\nNote: There are many normalization parameters. This is an example.\n\nmypepData <- normalize_global(omicsData = mypepData, subset_fn = "all", norm_fn = "mean")\n\n'), ifelse(is.null(spans_results), "", "spans_procedure(mypepData)\n\n"), ifelse(is.null(pepStats), '', '### *Statistical Analysis*\nNote: There are many imdanova parameters. This is an example.\n\nimdanova_res <- imd_anova(omicsData = mypepData, test_method = "anova"); plot(imdanova_res)'))}`
