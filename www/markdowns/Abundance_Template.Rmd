---
params:
  titleName: ""
  omicData: ""
  omicStats: ""
  omicDataRoll: ""
  omicStatsRoll: ""
  pmart_inputs: ""
  spans_results: ""
title: "`r params$titleName`"
date: "`r format(Sys.time(), '%B %d, %Y')`"
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, error = FALSE)
library(dplyr); library(pmartR); library(knitr); library(DT); library(ggplot2);
library(data.table); library(patchwork); library(purrr)
```

```{r Read in Results}
# This data will be passed to the markdown through shiny

# omicData and stats objects 
omicData <- params$omicData # The omic data (e.g. pepData, proData, lipiData, etc.)
omicDataAttr <- attributes(omicData) # The omic data attributes 
omicStats <- params$omicStats # The omic stats 
omicStatsAttr <- attributes(omicStats) # The omic stats attributes

# specific omicData and stats objects following roll up
omicDataRoll <- params$omicDataRoll # The rolled up omic data 
omicDataRollAttr <- attributes(omicDataRoll) # The rolled up omic data attributes
omicStatsRoll <- params$omicStatsRoll # The omic stats following roll up
omicStatsRollAttr <- attributes(omicStatsRoll) # The omic stats attributes following roll up

# Spans results
spans_results <- params$spans_results

# All inputs from tool 
pmart_inputs <- params$pmart_input
pmart_inputs$ReportCode <- TRUE

# Get the file type 
biomolecule <- switch(
  class(omicData),
  "pepData" = "unlabelled peptide",
  "isobaricpepData" = "isobaric peptide",
  "proData" = "unlabelled protein",
  "metabData" = "GC-LC/MS metabolite",
  "nmrData" = "NMR metabolite",
  "lipidData" = "lipid"
)
```

## Upload Data 

### *Expression Data*

A `r biomolecule` expression data file called **`r pmart_inputs$file_edata$name`** 
  was uploaded to the PMART application. This file contains `r length(omicData$e_data) - 1`
samples and `r length(unique(omicData$e_data[[omicDataAttr$cnames$edata_cname]]))` 
biomolecules designated by the **`r omicDataAttr$cnames$edata_cname`** column.
`r if (omicDataAttr$data_info$data_scale_orig == omicDataAttr$data_info$data_scale) {"The original scale of the data was **omicDataAttr$data_info$data_scale_orig** and remained unchanged."} else {paste0("The original scale of the data was **", omicDataAttr$data_info$data_scale_orig, "** and was transformed to **", omicDataAttr$data_info$data_scale, "**.")}` 
All missing data is denoted with **`r pmart_inputs$na_symbol`** and the expression data
**`r ifelse(pmart_inputs$normalized_yn == "0", "was not already", "was already")`** normalized. 

Here is the expression data matrix: 
  
```{r}
datatable(omicData$e_data, options = list(scrollX = TRUE))
```

`r if (is.null(omicDataAttr$cnames$emeta_cname) == FALSE) {paste0("### *Biomolecule Information*\nAn associated biomolecule information file was also uploaded called **", pmart_inputs$file_emeta$name, "** and the molecule identifier column was designated as **", omicDataAttr$cnames$emeta_cname, "**. The file contains ", length(omicData$e_meta) - 1, " columns of biomolecule information.")}`

```{r}
if (is.null(omicDataAttr$cnames$emeta_cname) == FALSE) {
  datatable(omicData$e_meta, options = list(scrollX = TRUE))
}
```


`r if ("Var1" %in% colnames(omicData$f_data) == FALSE) {paste0("### *Sample Information*\nAn associated sample information file was also uploaded called **", pmart_inputs$file_fdata$name, "**. Trimmed samples names **", ifelse(pmart_inputs$usevizsampnames == "No", "were not", "were"), "** used. The column in the sample information file which indicates sample names was designated as **", omicDataAttr$cnames$fdata_cname, "**.")}`

`r if (is.null(omicDataAttr$group_DF) == FALSE) {paste0("*Grouping Information*")}`

```{r Grouping Information: Main Effects and Covariates}
if (is.null(omicDataAttr$group_DF) == FALSE) {
  omicDataAttr$group_DF %>% datatable()
}
```

`r if (is.null(omicDataAttr$group_DF) == FALSE) {paste0("This table summarizes to which group or covariate each column in the expression data belongs.")}`

### *Code*

To generate a **`r biomolecule` object** in pmartR for this dataset, use: 
  
```{r, echo = FALSE}
if (is.null(omicDataAttr$cnames$fdata_cname)) {
  theUploadString <- "No code can be run, as all omicData objects require an e_data and f_data file."
} else {
  theUploadString <- paste0('omicObj <- as.pepData(e_data = read.csv("', pmart_inputs$file_edata$name, '"), e_data_cname = "', omicDataAttr$cnames$edata_cname, '", f_data = read.csv("', pmart_inputs$file_fdata$name, '"), f_data_cname = "', omicDataAttr$cnames$fdata_cname, '")')
}

if (!is.null(omicDataAttr$cnames$emeta_cname) & !is.null(omicDataAttr$cnames$fdata_cname)) {
  theUploadString <- theUploadString %>% 
    substr(1, nchar(theUploadString) - 1) %>%
    paste0(', e_meta = read.csv("', pmart_inputs$file_emeta$name, '"), e_meta_cname = "',
           omicDataAttr$cnames$emeta_cname, '")')
}
```

``r theUploadString``




