---
params:
  titleName: ""
  omicData: ""
  omicStats: ""
  omicDataRoll: ""
  omicStatsRoll: ""
  pmart_inputs: ""
  spans_results: ""
title: "`r params$titleName`"
date: "`r format(Sys.time(), '%B %d, %Y')`"
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, error = FALSE)
library(dplyr); library(pmartR); library(knitr); library(DT); library(ggplot2);
library(data.table); library(patchwork); library(purrr)
```

```{r Read in Results}
# This data will be passed to the markdown through shiny

# omicData and stats objects 
omicData <- params$omicData # The omic data (e.g. pepData, proData, lipiData, etc.)
omicDataAttr <- attributes(omicData) # The omic data attributes 
omicStats <- params$omicStats # The omic stats 
omicStatsAttr <- attributes(omicStats) # The omic stats attributes

# specific omicData and stats objects following roll up
omicDataRoll <- params$omicDataRoll # The rolled up omic data 
omicDataRollAttr <- attributes(omicDataRoll) # The rolled up omic data attributes
omicStatsRoll <- params$omicStatsRoll # The omic stats following roll up
omicStatsRollAttr <- attributes(omicStatsRoll) # The omic stats attributes following roll up

# Spans results
spans_results <- params$spans_results

# All inputs from tool 
pmart_inputs <- params$pmart_input
pmart_inputs$ReportCode <- TRUE

# Get the file type 
biomolecule <- switch(
  class(omicData),
  "pepData" = "unlabelled peptide",
  "isobaricpepData" = "isobaric peptide",
  "proData" = "unlabelled protein",
  "metabData" = "GC-LC/MS metabolite",
  "nmrData" = "NMR metabolite",
  "lipidData" = "lipid"
)
```

## Upload, Transform, and Format Data 

### *Expression Data*

A `r biomolecule` expression data file called **`r pmart_inputs$file_edata$name`** 
  was uploaded to the PMART application. This file contains `r length(omicData$e_data) - 1`
samples and `r length(unique(omicData$e_data[[omicDataAttr$cnames$edata_cname]]))` 
biomolecules designated by the **`r omicDataAttr$cnames$edata_cname`** column.
`r if (omicDataAttr$data_info$data_scale_orig == omicDataAttr$data_info$data_scale) {"The original scale of the data was **omicDataAttr$data_info$data_scale_orig** and remained unchanged."} else {paste0("The original scale of the data was **", omicDataAttr$data_info$data_scale_orig, "** and was transformed to **", omicDataAttr$data_info$data_scale, "**.")}` 
All missing data is denoted with **`r pmart_inputs$na_symbol`** and the expression data
**`r ifelse(pmart_inputs$normalized_yn == "0", "was not already", "was already")`** normalized. 

Here is the expression data matrix: 
  
```{r Expression Matrix}
datatable(omicData$e_data, options = list(scrollX = TRUE))
```

`r if (is.null(omicDataAttr$cnames$emeta_cname) == FALSE) {paste0("### *Biomolecule Information*\nAn associated biomolecule information file was also uploaded called **", pmart_inputs$file_emeta$name, "** and the molecule identifier column was designated as **", omicDataAttr$cnames$emeta_cname, "**. The file contains ", length(omicData$e_meta) - 1, " columns of biomolecule information.")}`

```{r Biomolecule Information}
if (is.null(omicDataAttr$cnames$emeta_cname) == FALSE) {
  datatable(omicData$e_meta, options = list(scrollX = TRUE))
}
```


`r if ("Var1" %in% colnames(omicData$f_data) == FALSE) {paste0("### *Sample Information*\nAn associated sample information file was also uploaded called **", pmart_inputs$file_fdata$name, "**. Trimmed samples names **", ifelse(pmart_inputs$usevizsampnames == "No", "were not", "were"), "** used. The column in the sample information file which indicates sample names was designated as **", omicDataAttr$cnames$fdata_cname, "**.")}`

`r if (is.null(omicDataAttr$group_DF) == FALSE) {paste0("*Grouping Information*")}`

```{r Grouping Information: Main Effects and Covariates}
if (is.null(omicDataAttr$group_DF) == FALSE) {
  omicDataAttr$group_DF %>% datatable()
}
```

`r if (is.null(omicDataAttr$group_DF) == FALSE) {paste0("This table summarizes to which group or covariate each column in the expression data belongs.")}`

`r if (!is.null(pmart_inputs$pair_id_col)) {paste0("### *Paired Data*\nPaired data was specified. The column with the pair IDs was designated as **", pmart_inputs$pair_id_col, "**, the group identifier column was designated as **", pmart_inputs$pair_group_col, "**, and the value within the group that contains the denominator was determined to be **", pmart_inputs$pair_denom_col, "**. The file contains ", length(unique(omicData$f_data[[pmart_inputs$pair_id_col]])), " unique pairs.")}`

```{r Paired Information}
if ((!is.null(pmart_inputs$pair_id_col))) {
  omicData$f_data %>% datatable()
}
```

### *Code*

To generate a **`r biomolecule` object** in pmartR for this dataset, use: 
  
```{r Formulate Upload Code, echo = FALSE}
theUploadString <- "No code can be run, as all omicData objects require an e_data and f_data file."

if (!is.null(pmart_inputs$file_fdata$name)) {
  theUploadString <- paste0('omicObj <- as.pepData(e_data = read.csv("', pmart_inputs$file_edata$name, '"), e_data_cname = "', omicDataAttr$cnames$edata_cname, '", f_data = read.csv("', pmart_inputs$file_fdata$name, '"), f_data_cname = "', omicDataAttr$cnames$fdata_cname, '")')
}

if (!is.null(omicDataAttr$cnames$emeta_cname) & !is.null(pmart_inputs$file_fdata$name)) {
  theUploadString <- theUploadString %>% 
    substr(1, nchar(theUploadString) - 1) %>%
    paste0(', e_meta = read.csv("', pmart_inputs$file_emeta$name, '"), e_meta_cname = "',
           omicDataAttr$cnames$emeta_cname, '")')
}
```

``r theUploadString``

Next, to log transform the data (if necessary), use: 

```{r Formulate Transformation Code}
theTransformString <- paste0('omicObj <- edata_transform(omicObj, data_scale = "', omicDataAttr$data_info$data_scale, '")')
```

``r theTransformString``

`r if(!is.null(pmart_inputs$file_fdata$name)) {"Next, to set group designations, use:"}`

```{r Formulate Group Designation Code, echo = FALSE}
theGroupString <- "No group designation was conducted."

if (!is.null(pmart_inputs$file_fdata$name)) {
  
  # Pull groups 
  gcols <- capture.output({c(pmart_inputs$gcol1, pmart_inputs$gcol2) %>% .[.!= "None"] %>% dput()})
  if (gcols == 'character(0)') {gcols <- "NULL"}
  
  # Pull covariates
  cvcols <- capture.output({c(pmart_inputs$cvcol1, pmart_inputs$cvcol2) %>% .[.!= "None"] %>% dput()})
  if (cvcols == 'character(0)') {cvcols <- "NULL"}
  
  theGroupString <- paste0('omicObj <- group_designation(omicObj, main_effects = ', gcols, ', covariates = ', cvcols, ')')
  
  # Add paired data information 
  if (!is.null(pmart_inputs$pair_id_col)) {
    theGroupString <- theGroupString %>%
      substr(1, nchar(theGroupString) - 1) %>% 
      paste0(', pair_id = "', pmart_inputs$pair_id_col, '", pair_group = "', pmart_inputs$pair_group_col, '", pair_denom = "', pmart_inputs$pair_denom_col, '")')
  }
  
}
```

``r theGroupString``

`r if (length(omicDataAttr$filters) > 0) {"## Filter Data"}`

```{r Filter: Table Summarizing Applied Filters}
#  Put applied filters in a table
FilterTable <- NULL

if (length(omicDataAttr$filters) != 0) {
  
  # Iterate through all the filters for the table, apply different logic for each filter type
  FilterTable <- do.call(rbind, lapply(omicDataAttr$filters, function(filter) {
    
    # Molecule Filter
    if (filter$type == "moleculeFilt") {
      return(c("Filter" = "Molecule Filter", 
               "pmartR Function" = "molecule_filter",
               "Type" = "Biomolecule", 
               "Parameters" = paste0("Min Number Molecules: ", filter$threshold), 
               "Summary" = paste0(filter$filtered %>% length(), " biomolecule(s) were filtered."),
               "First 5 Filtered" = paste0(filter$filtered[1:5][!is.na(filter$filtered[1:5])], collapse = " & ")
             ))
    } else
    
    # Proteomics Filter
    if (filter$type == "proteomicsFilt") {
      return(c("Filter" = "Proteomics Filter", 
               "pmartR Function" = "proteomics_filter",
               "Type" = "Biomolecule", 
               "Parameters" = paste0("Min Number of Peptides: ", filter$threshold$min_num_peps,
                      " & Degenerate Peptides Removed: ", ifelse(filter$threshold$degen_peps, "Yes", "No")),
               "Summary" = paste0(filter$filtered$e_data_remove %>% length(), " biomolecule(s) were filtered and ",
                                  filter$filtered$e_meta_remove %>% length(), " protein(s) were filtered."),
               "First 5 Filtered" = paste0(filter$filtered$e_data_remove[1:5][!is.na(filter$filtered$e_data_remove[1:5])],
                                           filter$filtered$e_meta_remove[1:5][!is.na(filter$filtered$e_meta_remove[1:5])],
                                           collapse = " & ")
              ))
    } else
      
    # CV Filter
    if (filter$type == "cvFilt") {
      return(c("Filter" = "CV Filter", 
               "pmartR Function" = "cv_filter",
               "Type" = "Biomolecule", 
               "Parameters" = paste0("Max CV: ", filter$threshold),
               "Summary" = paste0(filter$filtered %>% length(), " biomolecule(s) were filtered."),
               "First 5 Filtered" = paste0(filter$filtered[1:5][!is.na(filter$filtered[1:5])], collapse = " & ")
             ))
    } else
      
    # imd-ANOVA filter
    if (filter$type == "imdanovaFilt") {
      return(c("Filter" = "imd-ANOVA Filter", 
               "pmartR Function" = "imdanova_filter",
               "Type" = "Biomolecule", 
               "Parameters" = paste0("Min ANOVA: ", filter$threshold$min_nonmiss_anova,
                                     " & Min G-Test: ", filter$threshold$min_nonmiss_gtest),
               "Summary" = paste0(filter$filtered %>% length(), " biomolecule(s) were filtered."),
               "First 5 Filtered" = paste0(filter$filtered[1:5][!is.na(filter$filtered[1:5])], collapse = " & ")))
    } else 
      
    # rmd Filter
    if (filter$type == "rmdFilt") {
      return(c("Filter" = "rMD Filter", 
               "pmartR Function" = "rmd_filter",
               "Type" = "Sample", 
               "Parameters" = paste0("P-Value Threshold: ", filter$threshold, 
                                     " & Metrics Used: ", pmart_inputs$rmd_metrics %>% paste(collapse = ", ")),
               "Summary" = paste0(filter$filtered %>% length(), " sample(s) were filtered."),
               "First 5 Filtered" = paste0(filter$filtered[1:5][!is.na(filter$filtered[1:5])], collapse = " & ")))
    } else 
      
    # Custom filter
    if (filter$type == "customFilt") {
      return(c("Filter" = "Custom Filter", 
               "pmartR Function" = "custom_filter",
               "Type" = "Sample or Biomolecule", 
               "Parameters" = "",
               "Summary" = paste0(filter$filtered$f_data_remove %>% length(), " sample(s) were filtered. ",
                           filter$filtered$e_data_remove %>% length(), " biomolecule(s) were filtered. ", 
                           filter$filtered$e_meta_remove %>% length(), " protein(s) were filtered."),
               "First 5 Filtered" = paste0(filter$filtered$f_data_remove[1:5][!is.na(filter$filtered$f_data_remove[1:5])], 
                                           filter$filtered$e_data_remove[1:5][!is.na(filter$filtered$e_data_remove[1:5])],
                                           filter$filtered$e_meta_remove[1:5][!is.na(filter$filtered$e_meta_remove[1:5])],
                                           collapse = " & ")))
      
    } else {stop(paste0(filter$type, " is not a recognized filter type."))}
  
  })) %>% data.table()
  
  cbind("Order" = 1:nrow(FilterTable), FilterTable) %>% kable()
  
}
```

`r if ("Molecule Filter" %in% FilterTable$Filter) {paste0("### *Molecule Filter*\nA molecule filter was applied to the data, which removes biomolecule(s), **", omicDataAttr$cnames$edata_cname, "(s)**, not having at least the minimum number of samples (Min Number Molecules).")}`

`r if ("Proteomics Filter" %in% FilterTable$Filter) {paste0("### *Proteomics Filter*\nA degenerate peptide filter (Degenerate Peptides Removed) was applied to the data, which identifies peptides, **", omicDataAttr$cnames$edata_cname, "(s)**, not belonging to a single protein. Additionally, a protein filter can be applied to the data which identifies proteins not having at least a minimum number of peptides (Min Number of Peptides) mapping to them.")}`

`r if ("CV Filter" %in% FilterTable$Filter) {paste0("### *CV Filter*\nA coefficient of variation (CV) filter was applied to the data which removes biomolecule(s), **", omicDataAttr$cnames$edata_cname, "(s)**, with a CV greater than the threshold (Max CV).")} `

`r if ("imd-ANOVA Filter" %in% FilterTable$Filter) {paste0("### *imd-ANOVA Filter*\nAn ANOVA filter can be applied to the data which removes biomolecule(s), **", omicDataAttr$cnames$edata_cname, "(s)**, of non-missing values per group (Min ANOVA). Additionaly, an IMD (independence of missing data) filter can be applied to the data, removing biomolecules not having at least a minimum number of non-missing values (Min G-Test) in at least one of the groups.")}`

`r if ("rMD Filter" %in% FilterTable$Filter) {paste0("### *rMD Filter*\nA robust Mahalanobis distance (rMD) filter was applied to the data, removing sample(s), **", omicDataAttr$cnames$fdata_cname, "(s)**, with an associated rMD p-value of less than the threshold (P-Value Threshold). Metrics used to calculate the p-values are also included (Metrics Used).")}`

`r if ("Custom Filter" %in% FilterTable$Filter) {paste0("### *Custom Filter*\n Custom filters can be used to remove samples, biomolecules or proteins.")}`

`r if (length(omicDataAttr$filters) != 0) {paste0("### *Code*\n Use applyFilt to apply any filter to a dataset. For example, omicObj <- applyFilt(filter_object, omicObj, parameters). All filter functions have summary and plot options.")}`

`r if (omicDataAttr$data_info$norm_info$is_normalized) {paste0("## Normalization\n", biomolecule, " data **was** normalized.\n\n### *Manual*")}`

```{r Normalization: Manual, Plot}
if (omicDataAttr$data_info$norm_info$is_normalized) {
  
  if (is.null(omicDataAttr$group_DF) == FALSE) {
    
    plot(omicData, order_by = pmart_inputs$gcol1, color_by = pmart_inputs$gcol1, bw_theme = TRUE)
    
  } else {plot(omicData, bw_theme = TRUE)}  

}
```

`r if (omicDataAttr$data_info$norm_info$is_normalized) {paste0("A Kruskal-Wallis test can be used to ensure that the normalization approach does not introduce bias. A p-value greater than 0.05 is preferable. The p-value for this normalization is:")}`

```{r Normalization: Manual, Data Table}
if (is.null(omicDataAttr$data_info$norm_info$norm_type) == FALSE 
    && omicDataAttr$data_info$norm_info$norm_type == "global") {
  
  SubsetParameters <- ifelse(is.null(omicDataAttr$data_info$norm_info$subset_params), "",
    paste(lapply(names(omicDataAttr$data_info$norm_info$subset_params), function(name) {
      paste0(name, ": ", omicDataAttr$data_info$norm_info$subset_params[[name]])}), collapse = " & "))
  
  data.table("Attribute" = c("Subset Function", "Subset Parameters", "Normalization Function"),
             "Value" = c(omicDataAttr$data_info$norm_info$subset_fn, 
                         SubsetParameters, 
                         omicDataAttr$data_info$norm_info$norm_fn)) %>% kable()
}
```

`r if (is.null(spans_results) == FALSE) {"### *SPANS*\n\nSPANS **was** run to determine optimum normalization parameters."}`

```{r, SPANS}
if (is.null(spans_results) == FALSE) {
  plot(spans_results)
}
``` 

`r if (pmart_inputs$ReportCode && omicDataAttr$data_info$norm_info$is_normalized) {"### *Example Code*"}`




